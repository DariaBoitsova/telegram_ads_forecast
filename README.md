# Telegram Ads Reach Forecast

## Описание проекта

Telegram Ads Reach Forecast — это ML-сервис для прогнозирования охвата (`VIEWS`) рекламных объявлений в Telegram на основе исторических данных.

Сервис предназначен для data-driven медиапланирования и позволяет заранее оценить потенциальный охват рекламы **до запуска кампании**.

---

## Входные параметры прогноза

Во всех сценариях (API, форма, CSV) используются **одинаковые названия полей**, совпадающие с train dataset:

* `CPM` — стоимость за 1000 показов
* `CHANNEL_NAME` — Telegram-канал размещения
* `DATE` — дата размещения объявления (YYYY-MM-DD)

Целевая переменная:

* `VIEWS` — прогнозируемый охват

---

## Структура репозитория

```
telegram_ads_forecast/
├── data/
│   └── data_train.csv        # Исторические данные для обучения
├── models/                   # НЕ хранится в Git (скачивается при старте)
│   ├── catboost_views_model.cbm
│   └── channel_stats.pkl
├── src/
│   ├── api.py                # FastAPI: API + Web UI
│   ├── features.py           # Feature engineering (train == inference)
│   └── train.py              # Обучение модели
├── templates/
│   ├── index.html            # Главная страница (форма + CSV upload)
│   └── csv_result.html       # Preview результатов CSV
├── requirements.txt
├── README.md
└── .gitignore
```

---

## Данные

### Train dataset

Файл `data/data_train.csv` **намеренно хранится в репозитории**:

* обеспечивает воспроизводимость обучения
* позволяет проверить feature engineering
* используется для EDA

Основные колонки:

* `CPM`
* `CHANNEL_NAME`
* `DATE`
* `VIEWS`
* `CLICKS`, `ACTIONS` (вспомогательные)

---

## Модель

Используется `CatBoostRegressor`:

* поддержка категориальных признаков (`CHANNEL_NAME`)
* устойчивость к нелинейной зависимости CPM → VIEWS
* обучение в лог-пространстве: `log1p(VIEWS)`

### Feature engineering

Признаки формируются в `src/features.py` и **полностью совпадают** между обучением и инференсом:

* `CPM`, `cpm_log`, `cpm_sq`
* временные: `dayofweek`, `week`, `month`, `is_weekend`
* статистики канала:

  * `channel_mean_views`
  * `channel_median_views`
  * `channel_history_count`
* `cpm_vs_channel_mean`
* `CHANNEL_NAME` (категориальный)

---

## API и Web-интерфейс

### Главная страница

`GET /`

Веб-интерфейс предоставляет:

* форму для одиночного прогноза
* загрузку CSV-файла для batch-прогнозирования

---

### Одиночный прогноз (JSON API)

`POST /predict`

Пример запроса:

```json
{
  "CPM": 120.5,
  "CHANNEL_NAME": "crypto_news",
  "DATE": "2024-12-01"
}
```

Ответ:

```json
{
  "VIEWS": 18450
}
```

Данный endpoint предназначен для интеграций и программного использования.

---

### Одиночный прогноз (HTML форма)

`POST /predict_form`

Используется веб-форма на главной странице. Возвращает HTML-страницу с результатом прогноза.

---

### Batch-прогнозирование (CSV)

`POST /predict_csv`

#### Входной CSV (пример)

```csv
CPM,CHANNEL_NAME,DATE
120.5,crypto_news,2024-12-01
95.0,marketing_tips,2024-12-03
```

#### Результат

* отображается preview первых строк результата
* автоматически добавляется колонка `VIEWS`
* доступна кнопка скачивания полного CSV-файла

Пример результата:

```csv
CPM,CHANNEL_NAME,DATE,VIEWS
120.5,crypto_news,2024-12-01,18450
95.0,marketing_tips,2024-12-03,13210
```

---

## Хранение моделей

Файлы моделей **не хранятся в GitHub** из-за ограничений по размеру.

При старте приложения автоматически скачиваются:

* `catboost_views_model.cbm`
* `channel_stats.pkl`

Источник — Google Drive (через библиотеку `gdown`).

---

## Запуск проекта локально

```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\\Scripts\\activate

pip install -r requirements.txt

uvicorn src.api:app --host 0.0.0.0 --port 8000
```

После запуска приложение доступно по адресу:

```
http://localhost:8000
```

---

## Деплой

Проект разворачивается как Web Service (например, на Render):

* Start command:

```bash
uvicorn src.api:app --host 0.0.0.0 --port 10000
```

* Тип сервиса: Python Web Service
* Публичный доступ к API и Web UI

---

## Улучшение качества без переобучения

Для повышения качества и стабильности прогнозов без переобучения модели применены **inference-time оптимизации**:

* **Линейная калибровка предсказаний** — корректировка bias, возникающего после обучения в лог-пространстве (`log1p(VIEWS)`), с помощью калибровочного коэффициента.
* **Ограничение экстремальных значений (caps)** — мягкое ограничение прогнозируемого охвата на основе исторической средней статистики канала, что снижает влияние выбросов и повышает бизнес-интерпретируемость результатов.

Данные подходы позволяют улучшить метрики качества (MAE / RMSE) и стабильность прогнозов **без изменения модели и повторного обучения**.

---

## Ограничения и допущения

## Бизнес-ценность

Сервис позволяет:

* прогнозировать охват до запуска рекламы
* сравнивать Telegram-каналы при одинаковом CPM
* оптимизировать распределение рекламного бюджета
* использовать модель как готовый API-сервис для медиапланирования

Проект реализован как полноценный ML-сервис, готовый к использованию в production-сценариях.
